<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Analysis Service</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #333;
        }
        input[type="url"] { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="url"]:focus {
            outline: none;
            border-color: #007bff;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .result { 
            margin-top: 20px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            display: none; 
            background: #f8f9fa;
        }
        .loading { 
            display: none; 
            color: #007bff; 
            text-align: center;
            padding: 20px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .result-link { margin-top: 15px; }
        .result-link a { 
            color: #007bff; 
            text-decoration: none; 
            font-weight: bold;
        }
        .result-link a:hover { text-decoration: underline; }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 10px;
        }
        .description {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YouTube Analysis Service</h1>
        <p class="description">Nh·∫≠p URL YouTube ƒë·ªÉ ph√¢n t√≠ch video v√† ki·ªÉm tra AI probability</p>
        
        <form id="analyzeForm">
            <div class="form-group">
                <label for="youtubeUrl">URL YouTube:</label>
                <input type="url" id="youtubeUrl" name="youtube_url" required 
                       placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <button type="button" id="analyzeBtn" onclick="analyzeVideo()">Ph√¢n t√≠ch</button>
        </form>
        
        <div class="loading" id="loading">
            <div style="margin-bottom: 10px;">‚è≥ ƒêang x·ª≠ l√Ω... Vui l√≤ng ch·ªù trong gi√¢y l√°t.</div>
            <div style="width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: #007bff; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <div class="result" id="result">
            <h3>K·∫øt qu·∫£ ph√¢n t√≠ch:</h3>
            <div id="resultContent"></div>
            <div class="result-link" id="resultLink" style="display: none;">
                <a href="#" id="viewResultLink" target="_blank">üìä Xem k·∫øt qu·∫£ chi ti·∫øt ‚Üí</a>
            </div>
        </div>
    </div>
    
    <script>
        console.log('üöÄ YouTube Analysis Service - JavaScript loaded successfully');
        
        // H√†m ph√¢n t√≠ch video
        function analyzeVideo() {
            console.log('üñ±Ô∏è Button clicked! Starting analysis process...');
            
            // Ki·ªÉm tra c√°c element c√≥ t·ªìn t·∫°i kh√¥ng
            const urlInput = document.getElementById('youtubeUrl');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loadingDiv = document.getElementById('loading');
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            const resultLink = document.getElementById('resultLink');
            const viewResultLink = document.getElementById('viewResultLink');
            
            if (!urlInput || !analyzeBtn || !loadingDiv || !resultDiv || !resultContent || !resultLink || !viewResultLink) {
                console.error('‚ùå Missing required elements:', {
                    urlInput: !!urlInput,
                    analyzeBtn: !!analyzeBtn,
                    loadingDiv: !!loadingDiv,
                    resultDiv: !!resultDiv,
                    resultContent: !!resultContent,
                    resultLink: !!resultLink,
                    viewResultLink: !!viewResultLink
                });
                alert('L·ªói: Kh√¥ng th·ªÉ t√¨m th·∫•y c√°c th√†nh ph·∫ßn c·∫ßn thi·∫øt');
                return;
            }
            
            const url = urlInput.value;
            console.log('üîó YouTube URL to analyze:', url);
            
            if (!url) {
                console.log('‚ö†Ô∏è No URL provided - showing alert');
                alert('Vui l√≤ng nh·∫≠p URL YouTube');
                return;
            }
            
            console.log('‚úÖ URL validation passed');
            
            // Disable button
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            console.log('üîí Button disabled and text updated');
            
            // Show loading
            loadingDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            console.log('‚è≥ Loading indicator shown, result hidden');
            
            // Animate progress bar
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 500);
            
            console.log('üì§ Sending POST request to /api/analyze...');
            
            // G·ª≠i request
            fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ youtube_url: url })
            })
            .then(function(response) {
                console.log('üì• Received response - Status:', response.status, response.statusText);
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                return response.json();
            })
            .then(function(data) {
                console.log('üìä Response data received:', data);
                
                if (data.status === 'processing') {
                    console.log('‚úÖ Job created successfully');
                    console.log('üìã Job Status:', data.status);
                    console.log('üìã Job ID:', data.job_id);
                    console.log('üí¨ Message:', data.message);
                    
                    resultContent.innerHTML = 
                        '<p><strong>‚úÖ Job Status:</strong> ' + data.status + '</p>' +
                        '<p><strong>üìã Job ID:</strong> ' + data.job_id + '</p>' +
                        '<p><strong>‚è∞ Xin ƒë·ª£i k·∫øt qu·∫£...</strong></p>';
                    
                    // ·∫®n link k·∫øt qu·∫£ v√† b·∫Øt ƒë·∫ßu timer 20 gi√¢y
                    resultLink.style.display = 'none';
                    console.log('‚è≥ Job processing - hiding result link and starting 20s timer');
                    
                    // Sau 20 gi√¢y s·∫Ω hi·ªÉn th·ªã link k·∫øt qu·∫£
                    setTimeout(() => {
                        console.log('‚è∞ 20 seconds passed - showing result link');
                        
                        // C·∫≠p nh·∫≠t n·ªôi dung
                        resultContent.innerHTML = 
                            '<p><strong>‚úÖ Job Status:</strong> completed</p>' +
                            '<p><strong>üìã Job ID:</strong> ' + data.job_id + '</p>' +
                            '<p><strong>‚úÖ Ho√†n th√†nh ph√¢n t√≠ch!</strong></p>';
                        
                        // Hi·ªÉn th·ªã link k·∫øt qu·∫£
                        viewResultLink.href = '/app/result/' + data.job_id;
                        resultLink.style.display = 'block';
                        console.log('üîó Result link created: /app/result/' + data.job_id);
                        
                        // ƒê·∫£m b·∫£o result section hi·ªÉn th·ªã
                        document.getElementById('result').style.display = 'block';
                    }, 20000); // 20 gi√¢y
                    
                } else if (data.status === 'completed') {
                    console.log('‚úÖ Job completed immediately');
                    resultContent.innerHTML = 
                        '<p><strong>‚úÖ Job Status:</strong> ' + data.status + '</p>' +
                        '<p><strong>üìã Job ID:</strong> ' + data.job_id + '</p>' +
                        '<p><strong>‚úÖ Ho√†n th√†nh ph√¢n t√≠ch!</strong></p>';
                    
                    // Hi·ªÉn th·ªã link k·∫øt qu·∫£
                    viewResultLink.href = '/app/result/' + data.job_id;
                    resultLink.style.display = 'block';
                    console.log('üîó Result link created: /app/result/' + data.job_id);
                    
                } else {
                    console.log('‚ùå Error in response:', data.error || data.message);
                    resultContent.innerHTML = '<p style="color: red;">‚ùå L·ªói: ' + (data.error || data.message) + '</p>';
                    // ·∫®n link k·∫øt qu·∫£ n·∫øu c√≥ l·ªói
                    resultLink.style.display = 'none';
                }
            })
            .catch(function(error) {
                console.error('üí• Fetch error occurred:', error);
                console.error('üîç Error details:', error.message);
                clearInterval(progressInterval);
                resultContent.innerHTML = '<p style="color: red;">‚ùå L·ªói k·∫øt n·ªëi: ' + error.message + '</p>';
                // ·∫®n link k·∫øt qu·∫£ n·∫øu c√≥ l·ªói
                resultLink.style.display = 'none';
            })
            .finally(function() {
                console.log('üèÅ Request completed - Cleaning up UI');
                
                // Re-enable button
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Ph√¢n t√≠ch';
                console.log('üîì Button re-enabled');
                
                // Hide loading, show result
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                console.log('üìã Result section displayed');
                
                // ƒê·∫£m b·∫£o link k·∫øt qu·∫£ ƒë∆∞·ª£c ·∫©n n·∫øu ch∆∞a ho√†n th√†nh
                const currentContent = resultContent.innerHTML;
                if (currentContent.includes('‚ùå L·ªói') || currentContent.includes('‚è∞ Xin ƒë·ª£i k·∫øt qu·∫£')) {
                    resultLink.style.display = 'none';
                }
            });
        }
        

        
        // Th√™m event listener cho Enter key
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded - Ready to initialize components');
            
            const urlInput = document.getElementById('youtubeUrl');
            if (urlInput) {
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        analyzeVideo();
                    }
                });
                console.log('‚úÖ Enter key listener added');
            } else {
                console.error('‚ùå URL input not found');
            }
            
            // Ki·ªÉm tra t·∫•t c·∫£ c√°c element c·∫ßn thi·∫øt
            const requiredElements = [
                'youtubeUrl', 'analyzeBtn', 'loading', 'result', 
                'resultContent', 'resultLink', 'viewResultLink'
            ];
            
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            if (missingElements.length > 0) {
                console.error('‚ùå Missing elements:', missingElements);
            } else {
                console.log('‚úÖ All required elements found');
            }
            
            console.log('‚úÖ Event listeners set up successfully');
        });
    </script>
</body>
</html>
