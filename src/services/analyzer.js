const puppeteer = require('puppeteer');
const axios = require('axios');
const path = require('path');
const fs = require('fs-extra');

class AnalyzerService {
  constructor() {
    this.browser = null;
    this.screenshotsPath = process.env.SCREENSHOTS_PATH || './storage/screenshots';
  }

  async init() {
    if (!this.browser) {
      const args = [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--disable-gpu'
      ];

      // Th√™m tham s·ªë tu·ª≥ ch·ªânh t·ª´ bi·∫øn m√¥i tr∆∞·ªùng
      if (process.env.PUPPETEER_ARGS) {
        args.push(...process.env.PUPPETEER_ARGS.split(','));
      }

      this.browser = await puppeteer.launch({
        headless: process.env.PUPPETEER_HEADLESS !== 'false',
        args,
        defaultViewport: {
          width: 1280,
          height: 720
        }
      });
    }
  }

  async analyzeVideo(youtubeUrl, jobId) {
    try {
      await this.ensureDirectories();

      console.log(`üîç B·∫Øt ƒë·∫ßu ph√¢n t√≠ch video: ${youtubeUrl}`);

      // T·∫£i thumbnail g·ªëc c·ªßa YouTube thay v√¨ ch·ª•p m√†n h√¨nh
      const videoId = this.extractVideoId(youtubeUrl);
      if (!videoId) {
        throw new Error('Kh√¥ng th·ªÉ tr√≠ch xu·∫•t videoId t·ª´ URL');
      }

      const screenshotPath = await this.downloadThumbnail(videoId, jobId);

      // (T√πy ch·ªçn) C√≥ th·ªÉ b·ªï sung l·∫•y metadata sau n·∫øu c·∫ßn
      const metadata = { videoId };

      console.log(`‚úÖ Ph√¢n t√≠ch video ho√†n th√†nh. Thumbnail: ${screenshotPath}`);
      
      return screenshotPath;

    } catch (error) {
      console.error('‚ùå L·ªói trong qu√° tr√¨nh ph√¢n t√≠ch video:', error);
      throw error;
    }
  }

  async checkVideoAvailability(page) {
    try {
      // Ki·ªÉm tra c√°c th√¥ng b√°o l·ªói th∆∞·ªùng g·∫∑p
      const errorSelectors = [
        'ytd-player-error-message-renderer',
        '.ytp-error',
        '[data-error-code]'
      ];

      for (const selector of errorSelectors) {
        const errorElement = await page.$(selector);
        if (errorElement) {
          const errorText = await page.evaluate(el => el.textContent, errorElement);
          console.log(`‚ö†Ô∏è Ph√°t hi·ªán l·ªói video: ${errorText}`);
          return false;
        }
      }

      // Ki·ªÉm tra ph·∫ßn t·ª≠ video c√≥ t·ªìn t·∫°i/ngu·ªìn ph√°t
      const videoElement = await page.$('video');
      if (!videoElement) {
        console.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y video element');
        return false;
      }

      // Ki·ªÉm tra video kh√¥ng private ho·∫∑c ƒë√£ xo√°
      const titleElement = await page.$('h1.ytd-video-primary-info-renderer');
      if (!titleElement) {
        console.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ video');
        return false;
      }

      const title = await page.evaluate(el => el.textContent, titleElement);
      if (title.includes('Video kh√¥ng kh·∫£ d·ª•ng') || 
          title.includes('Video unavailable') ||
          title.includes('Private video') ||
          title.includes('Deleted video')) {
        console.log(`‚ö†Ô∏è Video kh√¥ng kh·∫£ d·ª•ng: ${title}`);
        return false;
      }

      return true;

    } catch (error) {
      console.error('‚ùå L·ªói khi ki·ªÉm tra t√≠nh kh·∫£ d·ª•ng c·ªßa video:', error);
      return false;
    }
  }

  async captureScreenshot(page, jobId) {
    try {
      // Ch·ªù ph·∫ßn ti√™u ƒë·ªÅ/metadata hi·ªÉn th·ªã (∆∞u ti√™n ch·ª•p metadata)
      await page.waitForSelector('h1, #title, ytd-watch-metadata', { timeout: 15000 });

      // Cu·ªôn t·ªõi v√πng ti√™u ƒë·ªÅ ƒë·ªÉ ch·ª•p r√µ n·ªôi dung kh√°c bi·ªát
      await page.evaluate(() => {
        const title = document.querySelector('h1, #title, ytd-watch-metadata');
        if (title) title.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });

      // Ch·ªù cu·ªôn xong
      await page.waitForTimeout(1000);

      // Ch·ª•p v√πng metadata n·∫øu c√≥, fallback sang player
      const screenshotPath = path.join(this.screenshotsPath, `screenshot_${jobId}.png`);
      
      await page.screenshot({
        path: screenshotPath,
        type: 'png',
        fullPage: false,
        clip: await this.getPreferredClipArea(page)
      });

      console.log(`üì∏ Screenshot ƒë√£ ƒë∆∞·ª£c ch·ª•p: ${screenshotPath}`);
      return screenshotPath;

    } catch (error) {
      console.error('‚ùå L·ªói khi ch·ª•p screenshot:', error);
      
      // D·ª± ph√≤ng: ch·ª•p to√†n b·ªô trang
      const screenshotPath = path.join(this.screenshotsPath, `screenshot_${jobId}.png`);
      await page.screenshot({
        path: screenshotPath,
        type: 'png',
        fullPage: true
      });
      
      return screenshotPath;
    }
  }

  async ensurePlayback(page, jobId) {
    try {
      await page.evaluate((seed) => {
        const video = document.querySelector('video');
        if (!video) return;
        // T·∫Øt ti·∫øng ƒë·ªÉ ƒë∆∞·ª£c ph√©p play trong headless
        video.muted = true;
        const duration = isFinite(video.duration) && video.duration > 0 ? video.duration : 0;
        // T·∫°o offset d·ª±a tr√™n seed ƒë·ªÉ tr√°nh lu√¥n ch·ª•p khung ƒë·∫ßu
        let offset = 2;
        if (duration > 10) {
          // hash ƒë∆°n gi·∫£n t·ª´ seed ƒë·ªÉ ch·ªçn m·ªëc 10%‚Äì30% duration
          let h = 0;
          for (let i = 0; i < seed.length; i++) h = (h * 31 + seed.charCodeAt(i)) >>> 0;
          const ratio = 0.1 + (h % 21) / 100; // 0.10 .. 0.31
          offset = Math.min(duration * ratio, duration - 1);
        }
        try {
          video.currentTime = offset;
        } catch {}
        try { video.play(); } catch {}
      }, String(jobId));
    } catch (e) {
      // B·ªè qua, fallback v·∫´n ch·ª•p ƒë∆∞·ª£c
    }
  }

  async getPreferredClipArea(page) {
    try {
      const clipArea = await page.evaluate(() => {
        const withinViewport = (r) => {
          const vw = window.innerWidth, vh = window.innerHeight;
          return {
            x: Math.max(0, r.x),
            y: Math.max(0, r.y),
            width: Math.min(vw - Math.max(0, r.x), r.width),
            height: Math.min(vh - Math.max(0, r.y), r.height)
          };
        };
        // ∆Øu ti√™n title + meta
        const titleCandidates = ['h1.ytd-watch-metadata','#title h1','#title','h1'];
        for (const s of titleCandidates) {
          const t = document.querySelector(s);
          if (t) {
            const r = t.getBoundingClientRect();
            if (r && r.width > 100 && r.height > 20) {
              // m·ªü r·ªông bao g·ªìm khu v·ª±c th√¥ng tin b√™n d∆∞·ªõi n·∫øu c√≥
              const info = document.querySelector('#owner, #upload-info, #info, ytd-watch-metadata');
              if (info) {
                const b = info.getBoundingClientRect();
                const minX = Math.min(r.x, b.x);
                const minY = Math.min(r.y, b.y);
                const maxX = Math.max(r.right, b.right);
                const maxY = Math.max(r.bottom, b.bottom);
                return withinViewport({ x: minX, y: minY, width: maxX - minX, height: maxY - minY });
              }
              return withinViewport(r);
            }
          }
        }

        // Fallback: player
        const sel = ['#player-container','ytd-player','.html5-video-container','video'];
        for (const s of sel) {
          const el = document.querySelector(s);
          if (el) {
            const r = el.getBoundingClientRect();
            if (r && r.width > 100 && r.height > 100) return withinViewport(r);
          }
        }
        return null;
      });

      if (clipArea) {
        return clipArea;
      }

      // D·ª± ph√≤ng: d√πng k√≠ch th∆∞·ªõc viewport
      const viewport = await page.viewport();
      return {
        x: 0,
        y: 0,
        width: viewport.width,
        height: viewport.height
      };

    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y k√≠ch th∆∞·ªõc video:', error);
      
      // D·ª± ph√≤ng m·∫∑c ƒë·ªãnh
      return {
        x: 0,
        y: 0,
        width: 1280,
        height: 720
      };
    }
  }

  async extractVideoMetadata(page) {
    try {
      const metadata = await page.evaluate(() => {
        const titleElement = document.querySelector('h1.ytd-video-primary-info-renderer');
        const channelElement = document.querySelector('ytd-channel-name yt-formatted-string.ytd-channel-name');
        const durationElement = document.querySelector('.ytp-time-duration');
        const viewCountElement = document.querySelector('span.view-count');

        return {
          title: titleElement ? titleElement.textContent.trim() : null,
          channel: channelElement ? channelElement.textContent.trim() : null,
          duration: durationElement ? durationElement.textContent.trim() : null,
          viewCount: viewCountElement ? viewCountElement.textContent.trim() : null
        };
      });

      console.log('üìä Metadata video:', metadata);
      return metadata;

    } catch (error) {
      console.error('‚ùå L·ªói khi tr√≠ch xu·∫•t metadata:', error);
      return {};
    }
  }

  async ensureDirectories() {
    try {
      await fs.ensureDir(this.screenshotsPath);
      console.log(`üìÅ ƒê√£ t·∫°o th∆∞ m·ª•c screenshots: ${this.screenshotsPath}`);
    } catch (error) {
      console.error('‚ùå L·ªói khi t·∫°o th∆∞ m·ª•c screenshots:', error);
      throw error;
    }
  }

  extractVideoId(youtubeUrl) {
    try {
      const url = new URL(youtubeUrl);
      if (url.hostname.includes('youtu.be')) {
        return url.pathname.replace('/', '').trim();
      }
      const v = url.searchParams.get('v');
      if (v) return v.trim();
      // Fallback: regex
      const m = youtubeUrl.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      return m ? m[1] : null;
    } catch {
      const m = youtubeUrl.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      return m ? m[1] : null;
    }
  }

  async downloadThumbnail(videoId, jobId) {
    const candidates = [
      `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
      `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`,
      `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
      `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`
    ];
    const targetPath = path.join(this.screenshotsPath, `screenshot_${jobId}.jpg`);

    for (const url of candidates) {
      try {
        const resp = await axios.get(url, { responseType: 'arraybuffer', timeout: 15000, validateStatus: () => true });
        if (resp.status >= 200 && resp.status < 300 && resp.data && resp.data.byteLength > 0) {
          await fs.writeFile(targetPath, Buffer.from(resp.data));
          return targetPath;
        }
      } catch (_) {
        // th·ª≠ url ti·∫øp theo
      }
    }
    throw new Error('Kh√¥ng th·ªÉ t·∫£i thumbnail YouTube');
  }

  async close() {
    if (this.browser) {
      await this.browser.close();
      this.browser = null;
      console.log('üîí ƒê√£ ƒë√≥ng browser Puppeteer');
    }
  }
}

module.exports = AnalyzerService;
